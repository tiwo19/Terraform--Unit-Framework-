# Enhanced Policy Configuration for Comprehensive Testing
# This file contains all organizational policies for complete coverage testing

policies:
  # SECURITY POLICIES (25 expected violations)
  - name: "require_s3_encryption"
    description: "All S3 buckets must have encryption enabled"
    resource_types:
      - "aws_s3_bucket"
    rules:
      - property: "server_side_encryption_configuration"
        required: true
      - property: "encryption"
        required: true

  - name: "secure_security_groups"
    description: "Security groups must not allow unrestricted dangerous access"
    resource_types:
      - "aws_security_group"
    rules:
      - property: "ingress"
        restrictions:
          - cidr_blocks: ["0.0.0.0/0"]
            ports: [22, 3389, 3306, 5432, 8080, 161]
            allowed: false

  - name: "secure_s3_public_access"
    description: "S3 buckets must block public access for security"
    resource_types:
      - "aws_s3_bucket_public_access_block"  
    rules:
      - property: "block_public_acls"
        required: true
        value: true
      - property: "block_public_policy"
        required: true
        value: true
      - property: "ignore_public_acls"
        required: true
        value: true
      - property: "restrict_public_buckets"
        required: true
        value: true

  - name: "ec2_security_requirements"
    description: "EC2 instances must meet security standards"
    resource_types:
      - "aws_instance"
    rules:
      - property: "monitoring"
        required: true
        value: true
      - property: "root_block_device.encrypted"
        required: true
        value: true

  # COMPLIANCE REQUIREMENTS (17 expected violations)
  - name: "financial_data_compliance"
    description: "Financial data must meet SOX compliance requirements"
    resource_types:
      - "aws_s3_bucket"
    rules:
      - property: "tags"
        required: true
        conditional_on:
          bucket_name_contains: "financial"
        required_keys:
          - "DataClassification"
          - "RetentionPeriod"
          - "ComplianceLevel"

  - name: "healthcare_data_compliance" 
    description: "Healthcare data must meet HIPAA compliance requirements"
    resource_types:
      - "aws_s3_bucket"
    rules:
      - property: "tags"
        required: true
        conditional_on:
          bucket_name_contains: "patient"
        required_keys:
          - "HIPAACompliant"
          - "DataRetention"

  - name: "production_governance"
    description: "Production resources must have governance controls"
    resource_types:
      - "aws_instance"
    rules:
      - property: "tags"
        required: true
        conditional_on:
          tags_contains: 
            Environment: "production"
        required_keys:
          - "ChangeControl"
          - "BackupPolicy" 
          - "DisasterRecovery"

  - name: "audit_and_logging"
    description: "Audit systems must have enhanced logging"
    resource_types:
      - "aws_instance"
    rules:
      - property: "tags"
        required: true
        conditional_on:
          name_contains: "audit"
        required_keys:
          - "AuditLevel"
          - "LogRetention"

  - name: "gdpr_compliance"
    description: "Customer data must meet GDPR requirements"
    resource_types:
      - "aws_s3_bucket"
    rules:
      - property: "tags"
        required: true
        conditional_on:
          bucket_name_contains: "customer"
        required_keys:
          - "GDPRCompliant"
          - "DataSovereignty"

  # RESOURCE TAGGING (12 expected violations)  
  - name: "mandatory_tags"
    description: "All resources must have mandatory organizational tags"
    resource_types:
      - "aws_instance"
      - "aws_s3_bucket"
      - "aws_security_group"
    rules:
      - property: "tags"
        required: true
        required_keys:
          - "Environment"
          - "Owner"
          - "Project"

  # NETWORK SECURITY (20 expected violations)
  - name: "network_segmentation"
    description: "Network resources must follow segmentation policies"
    resource_types:
      - "aws_security_group"
    rules:
      - property: "tags"
        required: true
        required_keys:
          - "NetworkZone"
          - "ComplianceLevel"
      - property: "ingress"
        restrictions:
          - cidr_blocks: ["0.0.0.0/0"]
            description_required: true

  - name: "ssh_access_control"
    description: "SSH access must be restricted and documented"
    resource_types:
      - "aws_security_group"
    rules:
      - property: "ingress"
        restrictions:
          - from_port: 22
            to_port: 22
            cidr_blocks: ["0.0.0.0/0"]
            allowed: false

  - name: "database_access_control"
    description: "Database ports must not be publicly accessible"
    resource_types:
      - "aws_security_group"
    rules:
      - property: "ingress"
        restrictions:
          - ports: [3306, 5432, 1433, 1521]
            cidr_blocks: ["0.0.0.0/0"]
            allowed: false

  # ENCRYPTION REQUIREMENTS (9 expected violations)
  - name: "storage_encryption"
    description: "All storage must be encrypted"
    resource_types:
      - "aws_s3_bucket"
      - "aws_instance"
    rules:
      - property: "encryption"
        required: true
        value: true
      - property: "encrypted"
        required: true
        value: true

  - name: "ebs_encryption"
    description: "All EBS volumes must be encrypted"
    resource_types:
      - "aws_instance"
    rules:
      - property: "root_block_device"
        required: true
      - property: "root_block_device.encrypted"
        required: true
        value: true

  - name: "instance_type_policy"
    description: "Only approved instance types allowed"
    resource_types:
      - "aws_instance" 
    rules:
      - property: "instance_type"
        allowed_values:
          - "t3.micro"
          - "t3.small"
          - "t3.medium"
